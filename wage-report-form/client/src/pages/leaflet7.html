<!DOCTYPE html>
<html>
<head>
  <title>Employer Map</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 600px; }
    .controls { margin: 10px; font-family: sans-serif; }
    .controls label { display: block; margin: 4px 0; }
    .leaflet-tooltip {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #aaa;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 2px 4px rgba(0,0,0,0.25);
    }
  </style>
</head>
<body>
  <div class="controls">
    <label>Filter by Job:
      <select id="jobFilter">
        <option value="all">All</option>
      </select>
    </label>
    <label>
      <input type="checkbox" id="companyFilter" /> Show companies only
    </label>
    <label>Minimum Salary:
      <input type="range" id="salaryFilter" min="0" max="1500" step="50" value="0">
      <span id="salaryValue">0</span>
    </label>
    <label>Minimum Environment Rating:
      <input type="range" id="envFilter" min="1" max="5" step="1" value="1">
      <span id="envValue">1</span>
    </label>
    <label>Minimum Social Rating:
      <input type="range" id="socialFilter" min="1" max="5" step="1" value="1">
      <span id="socialValue">1</span>
    </label>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    const map = L.map('map');
    // Keep OSM style, but use Carto's "Voyager" layer for a little less detail than default
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    let circles = [];
    let employerData = [];

    // Stronger red → pale yellow → strong green
    function salaryColor(value, min, max) {
      const ratio = (value - min) / (max - min);
      const r = Math.round(200 - 200 * ratio);
      const g = Math.round(80 + 160 * ratio);
      const b = Math.round(50 - 30 * ratio);
      return `rgb(${r},${g},${Math.max(b,0)})`;
    }

    function reviewSize(count) {
      return Math.min(6 + count * 1.3, 16); // slightly larger but not huge
    }

    Papa.parse('employers.csv', {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        employerData = [];
        results.data.forEach((r, index) => {
          if (!r.latitude || !r.longitude) {
            console.warn(`Row ${index + 1} skipped: missing coordinates.`);
            return;
          }
          employerData.push(r);
        });
        populateJobFilter();
        updateMap();
        fitToData();
      }
    });

    function fitToData() {
      const bounds = employerData.map(e => [parseFloat(e.latitude), parseFloat(e.longitude)]);
      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [30, 30], maxZoom: 10 }); // zoom in closer
      }
    }

    function populateJobFilter() {
      const jobs = [...new Set(employerData.map(e => e.job))];
      const jobSelect = document.getElementById('jobFilter');
      jobs.forEach(job => {
        const option = document.createElement("option");
        option.value = job;
        option.textContent = job;
        jobSelect.appendChild(option);
      });
    }

    function updateMap() {
      circles.forEach(c => map.removeLayer(c));
      circles = [];

      const jobFilter = document.getElementById('jobFilter').value;
      const companyOnly = document.getElementById('companyFilter').checked;
      const salaryMin = parseFloat(document.getElementById('salaryFilter').value);
      const envMin = parseFloat(document.getElementById('envFilter').value);
      const socialMin = parseFloat(document.getElementById('socialFilter').value);

      const salaries = employerData.map(e => parseFloat(e.avg_salary) || 0);
      const minSalary = Math.min(...salaries);
      const maxSalary = Math.max(...salaries);

      employerData.forEach(emp => {
        const salary = parseFloat(emp.avg_salary) || 0;
        const env = parseFloat(emp.avg_envir_rating) || 0;
        const social = parseFloat(emp.avg_social_rating) || 0;
        const reviews = parseInt(emp.review_count) || 1;
        const isCompany = emp.display_name !== "Private employer";

        if (jobFilter !== "all" && emp.job !== jobFilter) return;
        if (companyOnly && !isCompany) return;
        if (salary < salaryMin || env < envMin || social < socialMin) return;

        const circle = L.circleMarker([emp.latitude, emp.longitude], {
          radius: reviewSize(reviews),
          fillColor: salaryColor(salary, minSalary, maxSalary),
          color: "#222",
          weight: 0.6,
          opacity: 0.6,
          fillOpacity: 0.9
        }).addTo(map);

        const tooltipHtml = `
          <b>Employer:</b> ${emp.display_name}<br>
          <b>Location:</b> ${emp.loc}<br>
          <b>Work type:</b> ${emp.job}<br>
          <b>Reviews:</b> ${reviews}<br>
          <b>Average Salary:</b> ${(salary * 1000).toLocaleString()} TSh<br>
          <b>Environment Rating:</b> ${env} / 5<br>
          <b>Social Rating:</b> ${social} / 5
        `;
        circle.bindTooltip(tooltipHtml, { sticky: true });

        circles.push(circle);
      });
    }

    document.getElementById('jobFilter').addEventListener('change', updateMap);
    document.getElementById('companyFilter').addEventListener('change', updateMap);
    document.getElementById('salaryFilter').addEventListener('input', (e) => {
      document.getElementById('salaryValue').innerText = e.target.value;
      updateMap();
    });
    document.getElementById('envFilter').addEventListener('input', (e) => {
      document.getElementById('envValue').innerText = e.target.value;
      updateMap();
    });
    document.getElementById('socialFilter').addEventListener('input', (e) => {
      document.getElementById('socialValue').innerText = e.target.value;
      updateMap();
    });
  </script>
</body>
</html>
